/*! infowrap-filepicker - v0.1.2 - 2013-08-19
 * http://dev.infowrap.com/code/angular/angular-filepicker
 * Copyright (c) 2013 Infowrap;
 * Licensed MIT
 */
var infowrapFilepicker;angular.module("infowrapFilepicker.config",[]).value("infowrapFilepicker.config",{}),infowrapFilepicker=angular.module("infowrapFilepicker",["infowrapFilepicker.config"]),infowrapFilepicker.factory("infowrapFilepickerService",["infowrapFilepicker.config","infowrapFilepickerSecurity","$log","$window","$q","$rootScope","$timeout",function(e,r,n,i,t,o,a){var l,c,p,d,s,u,f,g,v;return c={},c.loadFilepicker=function(){var e,r;return r=t.defer(),$("body").append('<script type="text/javascript" src="//api.filepicker.io/v1/filepicker.js"></script>'),e=function(){return _.isUndefined(i.filepicker)?a(function(){return e()},50):r.resolve()},e(),r.promise},c.log=function(r,i){return e.debugLogging?i?n[i](r):n.log(r):void 0},c.events={},s="infowrapFilepicker",p=["pick","pickAndStore","exportFile","read","stat","write","writeUrl","store","convert","remove"],u=["pickedFiles","error","readingFiles","readingFilesComplete","readVCard","readProgress","resetFilesUploading","progress","storeProgress","writeUrlProgress","uploadProgress","uploadsComplete"],l=p.concat(u),f=["close"],c.events.modal={},_.forEach(f,function(e){return c.events.modal[e]=""+s+":modal:"+e}),_.forEach(l,function(e){return c.events[e]=""+s+":"+e,_.contains(p,e)?c[e]=function(){return c.log(""+e+" needs implementation!","error")}:void 0}),d={container:"modal",maxSize:5242880},g=_.extend(d,e.pickOptions),v=function(e){var r;return e=e||{},e.multiple=e.hasOwnProperty("multiple")?e.multiple:!0,r=_.clone(g,!0),_.extend(r,e),r},c.positionModal=function(){var r,n,t,o,a,l,c,p;return e.iframeContainer?(r=$("#"+e.iframeContainer),e.isMobile?(l=o=0,p=t="100%"):(c=$(i).outerWidth(!0),n=$(i).outerHeight(!0),p=""+c+"px",t=""+n+"px",l=50,o=c/2-r.width()/2,0>o&&(o=0)),a={top:""+l+"px",left:""+o+"px"},e.isMobile&&_.extend(a,{width:p,height:t}),r.css(a)):void 0},c.modalToggle=function(r){var n,t,l;return n=_.isUndefined(r)?!o.filepickerModalOpen:r,o.filepickerModalOpen=n,o.safeApply(),t=function(e){return 27===e.which&&(e.preventDefault(),o.filepickerModalOpen)?o.safeApply(function(){return c.modalToggle(!1)}):void 0},l=function(){return o.filepickerModalOpen?c.positionModal():void 0},n?($("body").bind("keydown",t),$(i).bind("resize",l),a(function(){return $(i).scrollTop(0)},e.isMobile?300:0)):($("body").unbind("keydown",t),$(i).unbind("resize",l))},c.pick=function(e){var r,n,i;return r=t.defer(),e=v(e),c.log(e),c.modalToggle(!0),i=function(e){return o.safeApply(function(){return c.modalToggle(!1),r.resolve(e)})},n=function(e){return c.log(e),o.safeApply(function(){return c.modalToggle(!1),r.reject(e)})},e.multiple?filepicker.pickMultiple(e,i,n):filepicker.pick(e,i,n),a(function(){return c.positionModal()},0),r.promise},c.pickAndStore=function(e){var r,n,i,l;return r=t.defer(),e=v(e),c.log(e),c.modalToggle(!0),i=function(e){return o.safeApply(function(){return c.modalToggle(!1),r.resolve(e)})},n=function(e){return c.log(e),o.safeApply(function(){return c.modalToggle(!1),r.reject(e)})},l={location:"S3",path:e.path},filepicker.pickAndStore(e,l,i,n),a(function(){return c.positionModal()},0),r.promise},c.writeUrl=function(e,r,n){var i,a;return a=t.defer(),n=n||{},i=_.first(r.split("?")),c.log(i),filepicker.writeUrl(e,i,n,function(e){return o.safeApply(function(){return a.resolve(e)})},function(e){return c.log(e),o.safeApply(function(){return a.reject(e)})}),a.promise},c.store=function(e,n){var i,a,l;return i=t.defer(),l=function(){var n,t,a;return a={input:e},n=r.cachedPolicies["new"],t={policy:n.encoded_policy,signature:n.signature,path:n.policy.path,location:"S3"},filepicker.store(e,t,function(e){return _.extend(a,{data:e}),o.safeApply(function(){return i.resolve(a)})},function(e){return c.log(e),_.extend(a,{error:e}),o.safeApply(function(){return i.reject(a)})},function(e){return _.extend(a,{progress:e}),o.safeApply(function(){return o.$broadcast(c.events.storeProgress,a)})})},r.hasCachedPolicy({"new":!0})?l():(a={"new":!0,projectId:n.wrapId},r.sign(a).then(function(){return l()})),i.promise},c["export"]=function(e,n){var i;return i=t.defer(),n=n||{},r.sign({id:e.id,"new":!0}).then(function(){var t,a;return t=r.cachedPolicies["new"],a={policy:t.encoded_policy,signature:t.signature},n=_.extend(n,a),filepicker.exportFile(e.url.url,n,function(e){return o.safeApply(function(){return i.resolve(e)})},function(e){return c.log(e),o.safeApply(function(){return i.reject(e)})})}),i.promise},c.read=function(e,n){var i,a,l,p,d,s;return i=t.defer(),n=n||{base64encode:!0},s=n.base64encode,l=function(t){var a,l;return c.log("filepicker.read: "+t),a=r.cachedPolicies.existing,_.extend(n,{policy:a.encoded_policy,signature:a.signature}),l={input:e},filepicker.read(t,n,function(e){return s&&(e="data:image/png;base64,"+e),_.extend(l,{data:e}),o.safeApply(function(){return i.resolve(l),o.$broadcast(c.events.read,l)})},function(e){return c.log(e),_.extend(l,{error:e}),o.safeApply(function(){return i.reject(l)})},function(e){return _.extend(l,{progress:e}),o.safeApply(function(){return o.$broadcast(c.events.readProgress,l)})})},a=function(e,r){var n;return n=e,_.isObject(e)&&(r&&_.isNumber(e.id)&&_.extend(r,{id:e.id}),n=_.isObject(e.url)?e.url.url:e.url),r&&-1===n.indexOf("policy")&&_.extend(r,{handle:n}),n},p={},d=a(e,p),r.sign(p).then(function(){return l(d)}),i.promise},c.previewTargetLoad=function(){var e;return c.dropDomId?(e=$("#"+c.dropDomId),e.addClass("loading-image")):void 0},c.previewTargetReady=function(e,r){var n,i,t,o,l;return n=$("#"+c.dropDomId),t=n.data("field-name"),i=void 0,i=e.data.replace(/\n/g,""),r||(l=document.createElement("image"),l.onload=function(){return a(function(){return n.removeClass("loading-image"),n.css({"background-image":"url("+i+")"})},100),l.src=""},l.src=i),o={fieldName:t,data:_.extend(e.input,{id:_.uniqueId()})}},c.readVCardData=function(e){var r;return r=t.defer(),e&&c.read(e,{asText:!0}).then(function(e){var n;return n={data:vCard.initialize(e.data),input:e.input},r.resolve(n),o.$broadcast(c.events.readVCard,n)}),r.promise},c.readFiles=function(e,r,n){var i,t,a;return n||o.$broadcast(c.events.readingFiles),c.dropTargetField||(r?(c.log("--------\nDropped on specific zone target!"),c.log(r),c.log("for: "+r.data("for"))):(i=0,t=function(){return i++,e.length>i?a():(o.$broadcast(c.events.readingFilesComplete),o.safeApply())},a=function(){var r,n,a,l;switch(r=e[i],n=r.name||r.filename,a="file_asset"!==r.type?r.type||r.mimetype||r.mime_type:r.mime_type,l={input:r},c.log("---------\nReading file:"),c.log(n+(" ("+a+")")),a.search(/image\/(gif|jpeg|png|tiff)/)>-1&&(a="image"),a){case"text/directory":return c.readVCardData(r).then(function(){return t()});case"image":return c.read(r).then(function(){return t()});case"text/plain":return t(),o.$broadcast(c.events.read,_.extend(l));case"application/pdf":return t(),o.$broadcast(c.events.read,_.extend(l))}},a())),o.safeApply()},c.addToFilesUploading=function(e){return c.filesUploading=c.filesUploading.concat(_.flatten(e)),_.forEach(c.filesUploading,function(e){return e.id=_.uniqueId(e.name||e.filename)})},c.setUploadProgress=function(e){var r;return r=Math.floor(e),c.log("Uploading ("+r+"%)"),c.uploadProgress=r,c.uploadProgressStyle={width:r+"%"},r>25?a(function(){var e,n,i;return e=$(".file-status"),i=e.find(".upload-percentage").width(),n=i-Math.floor(i*.01*r),e.find(".upload-percent-text").css({right:n+12+"px"})},200):void 0},c.uploadProgressClasses=function(){return c.filesUploading.length?"progress-striped active":"progress-info"},c.addToFilesUploaded=function(e){return c.filesUploaded=c.filesUploaded.concat(_.flatten(e)),_.forEach(c.filesUploaded,function(e){return e.hasOwnProperty("created_at")?void 0:e.created_at=JSON.parse(JSON.stringify(new Date))}),c.filesUploading=[],o.uploadsInProgress=!1},c.clearFilesUploaded=function(){return c.filesUploaded=[]},c.resetFileStatus=function(){return o.uploadsInProgress=!1,c.usedFilePickerDialog=!1,c.dropDomId=void 0,c.dropTargetId=void 0,c.dropTargetParentId=void 0,c.dropTargetType=void 0,c.dropTargetField=void 0,c.dropWindow=void 0,c.uploadProgress=0,c.uploadProgressStyle={width:"0px"},c.filesUploading=c.filesUploaded=[]},c.resetFileStatus(),c}]),infowrapFilepicker.factory("infowrapFilepickerSecurity",["infowrapFilepicker.config","$log","$q","$rootScope","$http",function(e,r,n,i,t){var o,a,l;return l=!1,a=function(e){return e?o.operations["new"]:o.operations.existing},o={},o.cachedPolicies={"new":{},existing:{}},o.operations={"new":["pick","store","storeUrl"],existing:["read","stat","convert","write","writeUrl"]},o.hasCachedPolicy=function(e){var r,n,i,t;return e=e||{},r=e["new"]?o.cachedPolicies["new"]:o.cachedPolicies.existing,r.policy&&(i=a(e["new"]),n=_.find(r.policy.call,function(e){return _.contains(i,e)}),n&&r.policy.expiry)?(t=Math.floor((new Date).getTime()/1e3),Number(r.policy.expiry)>=t):!1},o.sign=function(c){var p,d;return c=c||{},p=n.defer(),d={options:{call:a(c["new"])}},c.id&&_.extend(d.options,{file_id:c.id}),c.handle&&_.extend(d.options,{handle:c.handle.substr(c.handle.lastIndexOf("/")+1)}),c.size&&_.extend(d.options,{file_size:c.size}),c.projectId=c.projectId||i.currentProject.id,l||(l=!0,t.post(e.signApiUrl(c.projectId),d).success(function(n){return l=!1,e.debugLogging&&(r.log("--- filepicker security sign ---"),r.log(d.options.call)),c["new"]?o.cachedPolicies["new"]=n:o.cachedPolicies.existing=n,p.resolve()}).error(function(n){return l=!1,"filenotfound"===n.error&&e.debugLogging&&r.log(n.error),p.reject(n.error)})),i.safeApply(),p.promise},o.secureForReading=function(e,r){var i,t,a;return i=n.defer(),t=0,a=function(){var n,l;return n=e[t],l={},r&&r.id?l.id=n.id:l.handle=_.isObject(n.url)?n.url.url:n.url,o.sign(l).then(function(){var r,l;return l=o.cachedPolicies.existing,r="?signature="+l.signature+"&policy="+l.encoded_policy,_.isObject(n.url)?n.url.url+=r:n.url+=r,t++,t===e.length?i.resolve(e):a()})},a(),i.promise},o}]),infowrapFilepicker.run(["infowrapFilepicker.config","infowrapFilepickerService","$rootScope","$window",function(e,r,n,i){return n.safeApply=function(e){var r;return r=this.$root.$$phase,"$apply"!==r&&"$digest"!==r?e?n.$apply(e):n.$apply():e?n.$eval(e):void 0},e.apiKey?r.loadFilepicker().then(function(){return i.filepicker.setKey(e.apiKey)}):r.log("apiKey is required!","error"),n.filepickerModalOpen=!1,n.filepickerModalClose=function(){return r.modalToggle(!1)},n.$on("$routeChangeSuccess",function(){return r.modalToggle(!1)}),n.$on(r.events.modal.close,function(){return r.modalToggle(!1)})}]),infowrapFilepicker.directive("filepickerBtn",["infowrapFilepicker.config","infowrapFilepickerService","infowrapFilepickerSecurity","$timeout","$rootScope",function(e,r,n,i,t){var o;return o=function(i,o){var a;return a=function(a){var l,c,p;return _.isArray(a)||(a=[a]),r.resetFileStatus(),i.previewOnUpload?(i.previewTarget&&(p=o.closest(i.previewTarget),l=p.length?p:o.siblings(i.previewTarget),r.dropDomId=l.attr("id"),r.dropTargetType=l.data("target-type")),r.usedFilePickerDialog=!0,i.preventDefault?(c=function(e){return t.$broadcast(r.events.pickedFiles,e,i.targetType)},e.useSecurity?n.secureForReading(a).then(c):c(a)):(r.addToFilesUploading(a),r.readFiles(a))):i.storeLocation&&t.$broadcast(r.events.store,{data:a,targetId:i.targetId,targetParentId:i.targetParentId,targetType:i.targetType}),t.safeApply()},i.pick=function(){var t,o;return t=function(){var t,o,l;return e.useSecurity?(t=n.cachedPolicies["new"],o={policy:t.encoded_policy,signature:t.signature,path:t.policy.path}):o={},i.mimeTypes&&_.extend(o,{mimetypes:i.mimeTypes.split(",")}),"false"===i.multiple&&_.extend(o,{multiple:!1}),i.maxSize&&_.extend(o,{maxSize:Number(i.maxSize)}),i.services&&_.extend(o,{services:i.services.split(",")}),l=function(e){return r.log(e),a(_.isArray(e)?e:[e])},i.storeLocation?r.pickAndStore(o).then(l):r.pick(o).then(l)},e.useSecurity?n.hasCachedPolicy({"new":!0})?t():(o={"new":!0,projectId:i.targetParentId},n.sign(o).then(function(){return t()})):t()}},{restrict:"A",scope:{"class":"@",closeModalOnOpen:"@",btnClass:"@",dragAndDrop:"@",icon:"@",ignoreReadSigning:"@",mimeTypes:"@",maxSize:"@",multiple:"@",preventDefault:"@",previewOnUpload:"@",previewTarget:"@",services:"@",storeLocation:"@",targetId:"=?",targetParentId:"=?",targetType:"@",text:"@"},replace:!0,transclude:!0,template:"<div data-ng-click='pick($event)' data-ng-transclude></div>",link:o}}]);