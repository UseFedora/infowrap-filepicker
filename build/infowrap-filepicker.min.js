/*! infowrap-filepicker - v0.2.6 - 2013-11-06
 * http://dev.infowrap.com/code/angular/angular-filepicker
 * Copyright (c) 2013 Infowrap;
 * Licensed MIT
 */
var infowrapFilepicker;angular.module("infowrapFilepicker.config",[]).value("infowrapFilepicker.config",{}),infowrapFilepicker=angular.module("infowrapFilepicker",["infowrapFilepicker.config"]),infowrapFilepicker.config(["$provide",function(e){return e.decorator("$rootScope",["$delegate",function(e){return e.safeApply=function(r){var i;return i=e.$$phase,"$apply"!==i&&"$digest"!==i?e.$apply(r):void 0},e}])}]),infowrapFilepicker.factory("infowrapFilepickerService",["infowrapFilepicker.config","infowrapFilepickerSecurity","$log","$window","$q","$rootScope","$timeout",function(e,r,i,n,t,o,a){var p,c,l,s,d,u,f,g,y;return c={},c.loadFilepicker=function(){var r,i,o;return o=t.defer(),i=e.loadProtocol||"",$("body").append('<script type="text/javascript" src="'+i+'//api.filepicker.io/v1/filepicker.js"></script>'),r=function(){return _.isUndefined(n.filepicker)?a(function(){return r()},50):o.resolve()},r(),o.promise},c.log=function(r,n){return e.debugLogging?n?i[n](r):i.log(r):void 0},c.events={},d="infowrapFilepicker",l=["pick","pickAndStore","exportFile","read","stat","write","writeUrl","store","convert","remove"],u=["pickedFiles","error","readingFiles","readingFilesComplete","readVCard","readProgress","resetFilesUploading","progress","storeProgress","writeUrlProgress","uploadProgress","uploadsComplete"],p=l.concat(u),f=["close"],c.events.modal={},_.forEach(f,function(e){return c.events.modal[e]=""+d+":modal:"+e}),_.forEach(p,function(e){return c.events[e]=""+d+":"+e,_.contains(l,e)?c[e]=function(){return c.log(""+e+" needs implementation!","error")}:void 0}),s={container:"modal",maxSize:5242880},g=_.extend(s,e.pickOptions),y=function(e){var r;return e=e||{},e.multiple=e.hasOwnProperty("multiple")?e.multiple:!0,r=_.clone(g,!0),_.extend(r,e),r},c.positionModal=function(){var r,i,t,o,a,p,c,l,s;return e.iframeContainer?(r=$("#"+e.iframeContainer),i=angular.element(n),t=i.outerHeight(!0),e.isMobile?(c=a=0,s="100%",o=""+(t+60)+"px"):(l=i.outerWidth(!0),s=""+l+"px",o=""+t+"px",c=50,a=l/2-r.width()/2,0>a&&(a=0)),p={top:""+c+"px",left:""+a+"px"},e.isMobile&&_.extend(p,{width:s,height:o}),r.css(p)):void 0},c.modalToggle=function(r){var i,t,p,l,s;return p=_.isUndefined(r)?!o.filepickerModalOpen:r,o.filepickerModalOpen=p,o.safeApply(),l=function(e){return 27===e.which&&(e.preventDefault(),o.filepickerModalOpen)?o.safeApply(function(){return c.modalToggle(!1)}):void 0},s=function(){return o.filepickerModalOpen?c.positionModal():void 0},i=angular.element("body"),t=angular.element(n),p?(i.bind("keydown",l),t.bind("resize",s),a(function(){return t.scrollTop(0)},e.isMobile?300:0)):(i.unbind("keydown",l),t.unbind("resize",s))},c.pick=function(e){var r,i,n;return r=t.defer(),e=y(e),c.log(e),c.modalToggle(!0),n=function(e){return o.safeApply(function(){return c.modalToggle(!1),r.resolve(e)})},i=function(e){return c.log(e),o.safeApply(function(){return c.modalToggle(!1),r.reject(e)})},e.multiple?filepicker.pickMultiple(e,n,i):filepicker.pick(e,n,i),a(function(){return c.positionModal()},0),r.promise},c.pickAndStore=function(e){var r,i,n,p;return r=t.defer(),e=y(e),c.log(e),c.modalToggle(!0),n=function(e){return o.safeApply(function(){return c.modalToggle(!1),r.resolve(e)})},i=function(e){return c.log(e),o.safeApply(function(){return c.modalToggle(!1),r.reject(e)})},p={location:"S3",path:e.path},filepicker.pickAndStore(e,p,n,i),a(function(){return c.positionModal()},0),r.promise},c.writeUrl=function(e,r,i){var n,a;return a=t.defer(),i=i||{},n=_.first(r.split("?")),c.log(n),filepicker.writeUrl(e,n,i,function(e){return o.safeApply(function(){return a.resolve(e)})},function(e){return c.log(e),o.safeApply(function(){return a.reject(e)})}),a.promise},c.store=function(e,i){var n,a,p,l;return a=t.defer(),l=function(r){var i,n;return n={input:e},i={policy:r.encoded_policy,signature:r.signature,path:r.policy.path,location:"S3"},filepicker.store(e,i,function(e){return _.extend(n,{data:e}),o.safeApply(function(){return a.resolve(n)})},function(e){return c.log(e),_.extend(n,{error:e}),o.safeApply(function(){return a.reject(n)})})},n=r.getCachedPolicy({"new":!0}),n?l(n):(p={"new":!0},i.wrapId?p.wrapId=i.wrapId:i.signType&&(p.signType=i.signType),r.sign(p).then(function(e){return l(e)})),a.promise},c["export"]=function(e,i){var n;return n=t.defer(),i=i||{},r.sign({id:e.id,"new":!0}).then(function(){var t,a;return t=r.cachedPolicies["new"],a={policy:t.encoded_policy,signature:t.signature},i=_.extend(i,a),filepicker.exportFile(e.url.url,i,function(e){return o.safeApply(function(){return n.resolve(e)})},function(e){return c.log(e),o.safeApply(function(){return n.reject(e)})})}),n.promise},c.read=function(e,i){var n,a,p,l,s,d;return n=t.defer(),i=i||{base64encode:!0},d=i.base64encode,p=function(t){var a,p;return c.log("filepicker.read: "+t),a=r.cachedPolicies.existing,_.extend(i,{policy:a.encoded_policy,signature:a.signature}),p={input:e},filepicker.read(t,i,function(e){return d&&(e="data:image/png;base64,"+e),_.extend(p,{data:e}),o.safeApply(function(){return n.resolve(p),o.$broadcast(c.events.read,p)})},function(e){return c.log(e),_.extend(p,{error:e}),o.safeApply(function(){return n.reject(p)})})},a=function(e,r){var i;return i=e,_.isObject(e)&&(r&&_.isNumber(e.id)&&_.extend(r,{id:e.id}),i=_.isObject(e.url)?e.url.url:e.url),r&&-1===i.indexOf("policy")&&_.extend(r,{handle:i}),i},l={},s=a(e,l),r.sign(l).then(function(){return p(s)}),n.promise},c.previewTargetLoad=function(){var e;return c.dropDomId?(e=$("#"+c.dropDomId),e.addClass("loading-image")):void 0},c.previewTargetReady=function(e,r){var i,n,t,o,p;return i=$("#"+c.dropDomId),t=i.data("field-name"),n=void 0,n=e.data.replace(/\n/g,""),r||(p=document.createElement("image"),p.onload=function(){return a(function(){return i.removeClass("loading-image"),i.css({"background-image":"url("+n+")"})},100),p.src=""},p.src=n),o={fieldName:t,data:_.extend(e.input,{id:_.uniqueId()})}},c.readVCardData=function(e){var r;return r=t.defer(),e&&c.read(e,{asText:!0}).then(function(e){var i;return i={data:vCard.initialize(e.data),input:e.input},r.resolve(i),o.$broadcast(c.events.readVCard,i)}),r.promise},c.readFiles=function(e,r,i){var n,t,a;return i||o.$broadcast(c.events.readingFiles),c.dropTargetField||(r?(c.log("--------\nDropped on specific zone target!"),c.log(r),c.log("for: "+r.data("for"))):(n=0,t=function(){return n++,e.length>n?a():(o.$broadcast(c.events.readingFilesComplete),o.safeApply())},a=function(){var r,i,a,p;switch(r=e[n],i=r.name||r.filename,a="file_asset"!==r.type?r.type||r.mimetype||r.mime_type:r.mime_type,p={input:r},c.log("---------\nReading file:"),c.log(i+(" ("+a+")")),a.search(/image\/(gif|jpeg|png|tiff)/)>-1&&(a="image"),a){case"text/directory":return c.readVCardData(r).then(function(){return t()});case"image":return c.read(r).then(function(){return t()});case"text/plain":return t(),o.$broadcast(c.events.read,_.extend(p));case"application/pdf":return t(),o.$broadcast(c.events.read,_.extend(p))}},a())),o.safeApply()},c.addToFilesUploading=function(e){return c.filesUploading=c.filesUploading.concat(_.flatten(e)),_.forEach(c.filesUploading,function(e){return e.id=_.uniqueId(e.name||e.filename)})},c.setUploadProgress=function(e){var r;return r=Math.floor(e),c.log("Uploading ("+r+"%)"),c.uploadProgress=r,c.uploadProgressStyle={width:r+"%"},r>25?a(function(){var e,i,n;return e=$(".file-status"),n=e.find(".upload-percentage").width(),i=n-Math.floor(n*.01*r),e.find(".upload-percent-text").css({right:i+12+"px"})},200):void 0},c.uploadProgressClasses=function(){return c.filesUploading.length?"progress-striped active":"progress-info"},c.addToFilesUploaded=function(e){return c.filesUploaded=c.filesUploaded.concat(_.flatten(e)),_.forEach(c.filesUploaded,function(e){return e.hasOwnProperty("created_at")?void 0:e.created_at=JSON.parse(JSON.stringify(new Date))}),c.filesUploading=[],o.uploadsInProgress=!1},c.clearFilesUploaded=function(){return c.filesUploaded=[]},c.resetFileStatus=function(){return o.uploadsInProgress=!1,c.usedFilePickerDialog=!1,c.dropDomId=void 0,c.dropTargetId=void 0,c.dropTargetParentId=void 0,c.dropTargetType=void 0,c.dropTargetField=void 0,c.dropWindow=void 0,c.uploadProgress=0,c.uploadProgressStyle={width:"0px"},c.filesUploading=c.filesUploaded=[]},c.resetFileStatus(),c}]),infowrapFilepicker.factory("infowrapFilepickerSecurity",["infowrapFilepicker.config","$log","$q","$rootScope","$http",function(e,r,i,n,t){var o,a,p;return p=!1,a=function(e){return e?o.operations["new"]:o.operations.existing},o={},o.cachedPolicies={"new":{},existing:{},types:{}},o.operations={"new":["pick","store","storeUrl"],existing:["read","stat","convert","write","writeUrl"]},o.getCachedPolicy=function(e){var r,i,n,t;return e=e||{},_.isUndefined(e.signType)?r=o.cachedPolicies[e["new"]?"new":"existing"]:(r=o.cachedPolicies.types[e.signType],r&&(r=o.cachedPolicies.types[e.signType][e["new"]?"new":"existing"])),r&&r.policy&&(n=a(e["new"]),i=_.find(r.policy.call,function(e){return _.contains(n,e)}),i&&r.policy.expiry&&(t=Math.floor((new Date).getTime()/1e3),Number(r.policy.expiry)>=t))?r:!1},o.sign=function(c){var l,s,d;return c=c||{},s=i.defer(),d={options:{call:a(c["new"])}},c.id&&_.extend(d.options,{file_id:c.id}),c.handle&&_.extend(d.options,{handle:c.handle.substr(c.handle.lastIndexOf("/")+1)}),c.size&&_.extend(d.options,{file_size:c.size}),l=n.activeWrap?n.activeWrap.id:void 0,c.resourceId=c.wrapId||l,"account"===c.signType&&(c.resourceId=c.signTypeResourceId||n.currentUser.id),p||(p=!0,t.post(e.signApiUrl(c.resourceId,c.signType),d).success(function(i){var n,t;return p=!1,e.debugLogging&&(r.log("--- filepicker security sign ---"),r.log(d.options.call)),t=function(){var e;return e=o.cachedPolicies.types[c.signType],_.isUndefined(e)&&(o.cachedPolicies.types[c.signType]={}),o.cachedPolicies.types[c.signType][c["new"]?"new":"existing"]=i},n=function(){return c["new"]?_.isUndefined(c.signType)?o.cachedPolicies["new"]=i:t():_.isUndefined(c.signType)?o.cachedPolicies.existing=i:t()},s.resolve(n())}).error(function(i){return p=!1,"filenotfound"===i.error&&e.debugLogging&&r.log(i.error),s.reject(i.error)})),n.safeApply(),s.promise},o.secureForReading=function(e,r){var n,t,a;return n=i.defer(),t=0,a=function(){var i,p;return i=e[t],p={},r&&r.id?p.id=i.id:p.handle=_.isObject(i.url)?i.url.url:i.url,r.signType&&(p.signType=r.signType),r.signTypeResourceId&&(p.signTypeResourceId=r.signTypeResourceId),o.sign(p).then(function(){var r,c;return c=_.isUndefined(p.signType)?o.cachedPolicies.existing:o.cachedPolicies.types[p.signType].existing,r="?signature="+c.signature+"&policy="+c.encoded_policy,_.isObject(i.url)?i.url.url+=r:i.url+=r,t++,t===e.length?n.resolve(e):a()})},a(),n.promise},o}]),infowrapFilepicker.run(["infowrapFilepicker.config","infowrapFilepickerService","$rootScope","$window",function(e,r,i,n){return e.apiKey?r.loadFilepicker().then(function(){return n.filepicker.setKey(e.apiKey)}):r.log("apiKey is required!","error"),i.filepickerModalOpen=!1,i.filepickerModalClose=function(){return r.modalToggle(!1)},i.$on("$routeChangeSuccess",function(){return r.modalToggle(!1)}),i.$on(r.events.modal.close,function(){return r.modalToggle(!1)})}]),infowrapFilepicker.directive("filepickerBtn",["infowrapFilepicker.config","infowrapFilepickerService","infowrapFilepickerSecurity","$timeout","$rootScope",function(e,r,i,n,t){var o;return o=function(n,o){var a;return _.isUndefined(n.processWhen)||n.processWhen?(a=function(a){var p,c,l,s;return _.isArray(a)||(a=[a]),r.resetFileStatus(),n.previewOnUpload?(n.previewTarget&&(s=o.closest(n.previewTarget),p=s.length?s:o.siblings(n.previewTarget),r.dropDomId=p.attr("id"),r.dropTargetType=p.data("target-type")),r.usedFilePickerDialog=!0,n.preventDefault?(c=function(e){return t.$broadcast(r.events.pickedFiles,e,n.targetType)},e.useSecurity?(l={wrapId:n.targetParentId,signType:n.signType,signTypeResourceId:n.signTypeResourceId},i.secureForReading(a,l).then(c)):c(a)):(r.addToFilesUploading(a),r.readFiles(a))):n.storeLocation&&t.$broadcast(r.events.store,{data:a,targetId:n.targetId,targetParentId:n.targetParentId,targetType:n.targetType}),t.safeApply()},n.pick=function(){var t,o,p,c;return p=function(i){var t,o;return t=e.useSecurity?{policy:i.encoded_policy,signature:i.signature,path:i.policy.path}:{},n.mimeTypes&&_.extend(t,{mimetypes:n.mimeTypes.split(",")}),"false"===n.multiple&&_.extend(t,{multiple:!1}),n.maxSize&&_.extend(t,{maxSize:Number(n.maxSize)}),n.services&&_.extend(t,{services:n.services.split(",")}),o=function(e){return r.log(e),a(_.isArray(e)?e:[e])},n.storeLocation?r.pickAndStore(t).then(o):r.pick(t).then(o)},e.useSecurity?(o={"new":!0,signType:n.signType},t=i.getCachedPolicy(o),t?p(t):(c={"new":!0,wrapId:n.targetParentId,signType:n.signType,signTypeResourceId:n.signTypeResourceId},i.sign(c).then(function(e){return p(e)}))):p()}):(o.remove(),void 0)},{restrict:"A",scope:{closeModalOnOpen:"@",btnClass:"@",dragAndDrop:"@",icon:"@",ignoreReadSigning:"@",mimeTypes:"@",maxSize:"@",multiple:"@",preventDefault:"@",previewOnUpload:"@",previewTarget:"@",processWhen:"=?",services:"@",signType:"@",signTypeResourceId:"@",storeLocation:"@",targetId:"=?",targetParentId:"=?",targetType:"@",text:"@"},replace:!0,transclude:!0,template:"<div data-ng-transclude></div>",link:o}}]);