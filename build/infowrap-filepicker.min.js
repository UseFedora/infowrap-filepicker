/*! infowrap-filepicker - v0.3.6 - 2014-03-28
 * http://dev.infowrap.com/code/angular/angular-filepicker
 * Copyright (c) 2014 Infowrap;
 * Licensed MIT
 */
var infowrapFilepicker;infowrapFilepicker=angular.module("infowrapFilepicker",[]),infowrapFilepicker.config(["$provide",function(e){return e.decorator("$rootScope",["$delegate",function(e){return e.safeApply=function(r){var n;return n=e.$$phase,"$apply"!==n&&"$digest"!==n?e.$apply(r):r&&"function"==typeof r?r():void 0},e}])}]),infowrapFilepicker.provider("fpConfig",function(){var e,r,n,i;return e=void 0,r=!1,i=!1,n={},{setApiKey:function(r){return e=r},setDebug:function(e){return r=e},setSecurity:function(e){return i=e},setOptions:function(e){return n=e||{}},$get:function(){var t;return t={},t.apiKey=function(){return e},t.debug=function(){return r},t.security=function(){return i},t.options=function(){return n},t}}}),infowrapFilepicker.provider("infowrapFilepickerService",function(){return{$get:["fpConfig","infowrapFilepickerSecurity","$log","$window","$q","$rootScope","$timeout",function(e,r,n,i,t,o,a){var s,p,c,l,d,u,f,g,y;return p={},p.loadFilepicker=function(){var r,n,o;return o=t.defer(),n=e.options().loadProtocol||"",$("body").append('<script type="text/javascript" src="'+n+'//api.filepicker.io/v2/filepicker.js"></script>'),r=function(){return _.isUndefined(i.filepicker)?a(function(){return r()},50):o.resolve()},r(),o.promise},p.log=function(r,i){return e.debug()?i?n[i](r):n.log(r):void 0},p.events={},d="infowrapFilepicker",c=["pick","pickAndStore","exportFile","read","stat","write","writeUrl","store","convert","remove"],u=["pickedFiles","error","readingFiles","readingFilesComplete","readVCard","readProgress","resetFilesUploading","progress","storeProgress","writeUrlProgress","uploadProgress","uploadsComplete"],s=c.concat(u),f=["close"],p.events.modal={},_.forEach(f,function(e){return p.events.modal[e]=""+d+":modal:"+e}),_.forEach(s,function(e){return p.events[e]=""+d+":"+e,_.contains(c,e)?p[e]=function(){return p.log(""+e+" needs implementation!","error")}:void 0}),l={container:"modal",maxSize:5242880},g=_.extend(l,e.options().pickOptions),y=function(e){var r;return e=e||{},e.multiple=e.hasOwnProperty("multiple")?e.multiple:!0,r=_.clone(g,!0),_.extend(r,e),r},p.positionModal=function(){var r,n,t,o,a,s,p,c,l;return e.options().iframeContainer?(r=$("#"+e.options().iframeContainer),n=angular.element(i),t=n.outerHeight(!0),e.options().isMobile?(p=a=0,l="100%",o=""+(t+60)+"px"):(c=n.outerWidth(!0),l=""+c+"px",o=""+t+"px",p=50,a=c/2-r.width()/2,0>a&&(a=0)),s={top:""+p+"px",left:""+a+"px"},e.options().isMobile&&_.extend(s,{width:l,height:o}),r.css(s)):void 0},p.modalToggle=function(r){var n,t,s,c,l;return s=_.isUndefined(r)?!o.filepickerModalOpen:r,o.filepickerModalOpen=s,o.safeApply(),c=function(e){return 27===e.which&&(e.preventDefault(),o.filepickerModalOpen)?o.safeApply(function(){return p.modalToggle(!1)}):void 0},l=function(){return o.filepickerModalOpen?p.positionModal():void 0},n=angular.element("body"),t=angular.element(i),s?(n.bind("keydown",c),t.bind("resize",l),a(function(){return t.scrollTop(0)},e.options().isMobile?300:0)):(n.unbind("keydown",c),t.unbind("resize",l))},p.pick=function(e){var r,n,i;return r=t.defer(),e=y(e),p.log(e),p.modalToggle(!0),i=function(e){return o.safeApply(function(){return p.modalToggle(!1),r.resolve(e)})},n=function(e){return p.log(e),o.safeApply(function(){return p.modalToggle(!1),r.reject(e)})},e.multiple?filepicker.pickMultiple(e,i,n):filepicker.pick(e,i,n),a(function(){return p.positionModal()},0),r.promise},p.pickAndStore=function(e){var r,n,i,s;return r=t.defer(),e=y(e),p.log(e),p.modalToggle(!0),i=function(e){return o.safeApply(function(){return p.modalToggle(!1),r.resolve(e)})},n=function(e){return p.log(e),o.safeApply(function(){return p.modalToggle(!1),r.reject(e)})},s={location:"S3",path:e.path,access:"public"},filepicker.pickAndStore(e,s,i,n),a(function(){return p.positionModal()},0),r.promise},p.writeUrl=function(e,r,n){var i,a;return a=t.defer(),n=n||{},i=_.first(r.split("?")),p.log(i),filepicker.writeUrl(e,i,n,function(e){return o.safeApply(function(){return a.resolve(e)})},function(e){return p.log(e),o.safeApply(function(){return a.reject(e)})}),a.promise},p.store=function(e,n){var i,a,s,c;return a=t.defer(),c=function(r){var i,t;return t={input:e},i={policy:r.encoded_policy,signature:r.signature,path:r.policy.path,location:"S3",access:"public"},n.base64encode&&(i.base64decode=!0),n.filename&&(i.filename=n.filename),n.mimetype&&(i.mimetype=n.mimetype),filepicker.store(e,i,function(e){return _.extend(t,{data:e}),o.safeApply(function(){return a.resolve(t)})},function(e){return p.log(e),_.extend(t,{error:e}),o.safeApply(function(){return a.reject(t)})})},i=r.getCachedPolicy({"new":!0}),i?c(i):(s={"new":!0},n.wrapId?s.wrapId=n.wrapId:n.signType&&(s.signType=n.signType),r.sign(s).then(function(e){return c(e)})),a.promise},p.storeUrl=function(e,n){var i,a,s,c;return a=t.defer(),c=function(r){var i,t;return t={input:e},i={policy:r.encoded_policy,signature:r.signature,path:r.policy.path,location:"S3",access:"public"},n.filename&&(i.filename=n.filename),filepicker.storeUrl(e,i,function(e){return _.extend(t,{data:e}),o.safeApply(function(){return a.resolve(t)})},function(e){return p.log(e),_.extend(t,{error:e}),o.safeApply(function(){return a.reject(t)})})},i=r.getCachedPolicy({"new":!0}),i?c(i):(s={"new":!0},n.wrapId?s.wrapId=n.wrapId:n.signType&&(s.signType=n.signType),r.sign(s).then(function(e){return c(e)})),a.promise},p["export"]=function(e,n){var i;return i=t.defer(),n=n||{},r.sign({id:e.id,"new":!0}).then(function(){var t,a;return t=r.cachedPolicies["new"],a={policy:t.encoded_policy,signature:t.signature},n=_.extend(n,a),filepicker.exportFile(e.url.url,n,function(e){return o.safeApply(function(){return i.resolve(e)})},function(e){return p.log(e),o.safeApply(function(){return i.reject(e)})})}),i.promise},p.read=function(e,n){var i,a,s,c,l,d;return i=t.defer(),n=n||{base64encode:!0},d=n.base64encode,s=function(t){var a,s;return p.log("filepicker.read: "+t),a=r.cachedPolicies.existing,_.extend(n,{policy:a.encoded_policy,signature:a.signature}),s={input:e},filepicker.read(t,n,function(e){return d&&(e="data:image/png;base64,"+e),_.extend(s,{data:e}),o.safeApply(function(){return i.resolve(s),o.$broadcast(p.events.read,s)})},function(e){return p.log(e),_.extend(s,{error:e}),o.safeApply(function(){return i.reject(s)})})},a=function(e,r){var n;return n=e,_.isObject(e)&&(r&&_.isNumber(e.id)&&_.extend(r,{id:e.id}),n=_.isObject(e.url)?e.url.url:e.url),r&&-1===n.indexOf("policy")&&_.extend(r,{handle:n}),n},c={},l=a(e,c),r.sign(c).then(function(){return s(l)}),i.promise},p.previewTargetLoad=function(){var e;return p.dropDomId?(e=$("#"+p.dropDomId),e.addClass("loading-image")):void 0},p.previewTargetReady=function(e,r){var n,i,t,o,s;return n=$("#"+p.dropDomId),t=n.data("field-name"),i=void 0,i=e.data.replace(/\n/g,""),r||(s=document.createElement("image"),s.onload=function(){return a(function(){return n.removeClass("loading-image"),n.css({"background-image":"url("+i+")"})},100),s.src=""},s.src=i),o={fieldName:t,data:_.extend(e.input,{id:_.uniqueId()})}},p.readVCardData=function(e){var r;return r=t.defer(),e&&p.read(e,{asText:!0}).then(function(e){var n;return n={data:vCard.initialize(e.data),input:e.input},r.resolve(n),o.$broadcast(p.events.readVCard,n)}),r.promise},p.readFiles=function(e,r,n){var i,t,a;return n||o.$broadcast(p.events.readingFiles),p.dropTargetField||(r?(p.log("--------\nDropped on specific zone target!"),p.log(r),p.log("for: "+r.data("for"))):(i=0,t=function(){return i++,i<e.length?a():(o.$broadcast(p.events.readingFilesComplete),o.safeApply())},(a=function(){var r,n,a,s;switch(r=e[i],n=r.name||r.filename,a="file_asset"!==r.type?r.type||r.mimetype||r.mime_type:r.mime_type,s={input:r},p.log("---------\nReading file:"),p.log(n+(" ("+a+")")),a.search(/image\/(gif|jpeg|png|tiff)/)>-1&&(a="image"),a){case"text/directory":return p.readVCardData(r).then(function(){return t()});case"image":return p.read(r).then(function(){return t()});case"text/plain":return t(),o.$broadcast(p.events.read,_.extend(s));case"application/pdf":return t(),o.$broadcast(p.events.read,_.extend(s))}})())),o.safeApply()},p.addToFilesUploading=function(e){return p.filesUploading=p.filesUploading.concat(_.flatten(e)),_.forEach(p.filesUploading,function(e){return e.id=_.uniqueId(e.name||e.filename)})},p.setUploadProgress=function(e){var r;return r=Math.floor(e),p.log("Uploading ("+r+"%)"),p.uploadProgress=r,p.uploadProgressStyle={width:r+"%"},r>25?a(function(){var e,n,i;return e=$(".file-status"),i=e.find(".upload-percentage").width(),n=i-Math.floor(.01*i*r),e.find(".upload-percent-text").css({right:n+12+"px"})},200):void 0},p.uploadProgressClasses=function(){return p.filesUploading.length?"progress-striped active":"progress-info"},p.addToFilesUploaded=function(e){return p.filesUploaded=p.filesUploaded.concat(_.flatten(e)),_.forEach(p.filesUploaded,function(e){return e.hasOwnProperty("created_at")?void 0:e.created_at=JSON.parse(JSON.stringify(new Date))}),p.filesUploading=[],o.uploadsInProgress=!1},p.clearFilesUploaded=function(){return p.filesUploaded=[]},p.resetFileStatus=function(){return o.uploadsInProgress=!1,p.usedFilePickerDialog=!1,p.dropDomId=void 0,p.dropTargetId=void 0,p.dropTargetParentId=void 0,p.dropTargetType=void 0,p.dropTargetField=void 0,p.dropWindow=void 0,p.uploadProgress=0,p.uploadProgressStyle={width:"0px"},p.filesUploading=p.filesUploaded=[]},p.resetFileStatus(),p}]}}),infowrapFilepicker.provider("infowrapFilepickerSecurity",function(){return{$get:["fpConfig","$log","$q","$rootScope","$http",function(e,r,n,i,t){var o,a,s;return s=!1,a=function(e){return e?o.operations["new"]:o.operations.existing},o={},o.cachedPolicies={"new":{},existing:{},types:{}},o.operations={"new":["pick","store","storeUrl"],existing:["read","stat","convert","write","writeUrl"]},o.getCachedPolicy=function(e){var r,n,i,t;return e=e||{},_.isUndefined(e.signType)?r=o.cachedPolicies[e["new"]?"new":"existing"]:(r=o.cachedPolicies.types[e.signType],r&&(r=o.cachedPolicies.types[e.signType][e["new"]?"new":"existing"])),r&&r.policy&&(i=a(e["new"]),n=_.find(r.policy.call,function(e){return _.contains(i,e)}),n&&r.policy.expiry&&(t=Math.floor((new Date).getTime()/1e3),t<=Number(r.policy.expiry)))?r:!1},o.sign=function(p){var c,l,d,u;return p=p||{},l=n.defer(),u={options:{call:a(p["new"])}},p.id&&_.extend(u.options,{file_id:p.id}),p.handle&&_.extend(u.options,{handle:p.handle.substr(p.handle.lastIndexOf("/")+1)}),p.size&&_.extend(u.options,{file_size:p.size}),c=i.activeWrap?i.activeWrap.id:void 0,p.resourceId=p.wrapId||c,"account"===p.signType&&(p.resourceId=p.signTypeResourceId||i.currentUser.id),s||(s=!0,d=function(n){var t,o,a,s,p;if(r.log("--- filepicker security sign ERROR ---"),"filenotfound"===n&&e.debug()&&r.log(n),e.options().errorHandling){for(s=e.options().errorHandling,p=[],o=0,a=s.length;a>o;o++)t=s[o],p.push(_.contains(t.msgs,n)?i.$emit(t.eventName,{data:{error:n}}):void 0);return p}},t.post(e.options().signApiUrl(p.resourceId,p.signType),u).success(function(n){var i,t;return s=!1,n&&n.error?(d(n.error),l.reject(n.error)):(e.debug()&&(r.log("--- filepicker security sign ---"),r.log(u.options.call)),t=function(){var e;return e=o.cachedPolicies.types[p.signType],_.isUndefined(e)&&(o.cachedPolicies.types[p.signType]={}),o.cachedPolicies.types[p.signType][p["new"]?"new":"existing"]=n},i=function(){return p["new"]?_.isUndefined(p.signType)?o.cachedPolicies["new"]=n:t():_.isUndefined(p.signType)?o.cachedPolicies.existing=n:t()},l.resolve(i()))}).error(function(e){return s=!1,e&&e.error&&d(e.error),l.reject(e.error)})),i.safeApply(),l.promise},o.secureForReading=function(e,r){var i,t,a;return i=n.defer(),t=0,a=function(){var n,s;return n=e[t],s={},r&&r.id?s.id=n.id:s.handle=_.isObject(n.url)?n.url.url:n.url,r.signType&&(s.signType=r.signType),r.signTypeResourceId&&(s.signTypeResourceId=r.signTypeResourceId),o.sign(s).then(function(){var r,p;return p=_.isUndefined(s.signType)?o.cachedPolicies.existing:o.cachedPolicies.types[s.signType].existing,r="?signature="+p.signature+"&policy="+p.encoded_policy,_.isObject(n.url)?n.url.url+=r:n.url+=r,t++,t===e.length?i.resolve(e):a()})},a(),i.promise},o}]}}),infowrapFilepicker.run(["fpConfig","infowrapFilepickerService","$rootScope","$window",function(e,r,n,i){return e.apiKey()?r.loadFilepicker().then(function(){return i.filepicker.setKey(e.apiKey())}):r.log("apiKey is required!","error"),n.filepickerModalOpen=!1,n.filepickerModalClose=function(){return r.modalToggle(!1)},n.$on("$routeChangeSuccess",function(){return r.modalToggle(!1)}),n.$on(r.events.modal.close,function(){return r.modalToggle(!1)})}]),infowrapFilepicker.directive("filepickerBtn",["fpConfig","infowrapFilepickerService","infowrapFilepickerSecurity","$timeout","$rootScope",function(e,r,n,i,t){var o;return o=function(i,o){var a,s;return _.isUndefined(i.processWhen)||i.processWhen?(s=function(a){var s,p,c,l;return _.isArray(a)||(a=[a]),r.resetFileStatus(),i.previewOnUpload?(i.previewTarget&&(l=o.closest(i.previewTarget),s=l.length?l:o.siblings(i.previewTarget),r.dropDomId=s.attr("id"),r.dropTargetType=s.data("target-type")),r.usedFilePickerDialog=!0,i.preventDefault?(p=function(e){return t.$broadcast(r.events.pickedFiles,e,i.targetType)},e.security()?(c={wrapId:i.targetParentId,signType:i.signType,signTypeResourceId:i.signTypeResourceId},n.secureForReading(a,c).then(p)):p(a)):(r.addToFilesUploading(a),r.readFiles(a))):i.storeLocation&&t.$broadcast(r.events.store,{data:a,targetId:i.targetId,targetParentId:i.targetParentId,targetType:i.targetType}),t.safeApply()},a=function(){var o,a,p,c;return p=function(n){var o,a;return o=e.security()?{policy:n.encoded_policy,signature:n.signature,path:n.policy.path}:{},i.mimeTypes&&_.extend(o,{mimetypes:i.mimeTypes.split(",")}),"false"===i.multiple&&_.extend(o,{multiple:!1}),i.maxSize&&_.extend(o,{maxSize:Number(i.maxSize)}),i.services&&_.extend(o,{services:i.services.split(",")}),i.services&&-1!=i.services.indexOf("CUSTOMSOURCE")&&_.extend(o,{openTo:"CUSTOMSOURCE"}),a=function(e){return r.log(e),s(_.isArray(e)?e:[e])},t.safeApply(function(){return r.pickAndStore(o).then(a)})},e.security()?(a={"new":!0,signType:i.signType},o=n.getCachedPolicy(a),o?p(o):(c={"new":!0,wrapId:i.targetParentId,signType:i.signType,signTypeResourceId:i.signTypeResourceId},t.safeApply(function(){return n.sign(c).then(function(e){return p(e)})}))):p()},o.bind("click",a)):void o.remove()},{restrict:"A",scope:{closeModalOnOpen:"@",btnClass:"@",dragAndDrop:"@",icon:"@",ignoreReadSigning:"@",mimeTypes:"@",maxSize:"@",multiple:"@",preventDefault:"@",previewOnUpload:"@",previewTarget:"@",processWhen:"=?",services:"@",signType:"@",signTypeResourceId:"@",storeLocation:"@",targetId:"=?",targetParentId:"=?",targetType:"@",text:"@"},replace:!0,transclude:!0,template:"<div data-ng-transclude></div>",link:o}}]);